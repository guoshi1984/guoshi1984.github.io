\documentclass[a4paper]{article}
\usepackage{amssymb, amsmath}
\usepackage{graphicx}
\title{A Review of Option Pricing Models and Simulations}
\author{Shi Guo} 
\begin{document}
\maketitle
{\bf Abstract} In this article, we present a variety of methods for pricing options and the simulation results. We review the theory of the Black-Scholes-Merton model, the Heston model with stochastic volatility and the Bates model that contains diffusions with jumps. We analyze each model with possible analytical solutions. Then we introduce the Monte Carlo simulation algorithms for each model. A special algorithm for handling early exercising feature of American style option is provided. Finally, we present the simulation results and compare the results with literature.\\
\line(1,0) {350}
\section{European Option Pricing Models}
In this section we first present two approaches for pricing European options: One is to solve Black-Scholes-Merton partial differential equation and the other one is using Martingale property. We are going to show these two approches are equivalent as they are connnected through Faynman-Kac formula. Then we present the analytical solutions and discussions. 
\subsection{Black Scholes Merton Equation: Introduction}
Here is basic idea for pricing options. We consider a portfolio composed of certain shares of stock and a saving account with an interest rate then use the portfolio to replicate the payoff of the option. If we are able to replicate the payoff successfully, we can set the value of the portfolio equal to the price of the option. We briefly go through the steps to derive the Black Scholes Merton equation. We assume the stock prices following a geometric Brownian motion\\
1) Stock price:\\
\begin{align*}
	 dS(t) = \alpha S(t) dt + \sigma S(t) dW(t)\\
\end{align*}
 
\noindent 2) We have a portfolio X(t) which consists of $\Delta(t)$ share of stock  $\Delta(t) S(t)$, and $(X(t) - \Delta (t) S(t))$ money market account with interest rate r. \\  
\begin{align*}
	X(t) = \Delta(t) dS(t) + r(X(t) -\Delta(t) S(t)) dt\\
\end{align*}
\noindent 3) Change of the portfolio with respect to time
\begin{align*}
	  d X(t) & = \Delta(t) d S(t) + r(X(t) - \Delta(t) S(t)) dt \\
             & = r X(t) dt + \Delta(t) (\alpha - r )S(t) + \Delta (t) \sigma S(t) d W(t) \\
\end{align*}
                      
\noindent 4) Change of the present value of the stock with respect to time\\
\begin{align*}
	d(e^{-r t} S(t)) & = (\alpha - r) e^{- r t}S(t) dt + \sigma e^{- r t} S(t) dW(t) \\
\end{align*}

\noindent 5) With a few steps, we get change of the present value of the portfolio with respect to time\\
\begin{align}\label{discounted X}
  d(e^{- r t} X(t)) 
 =  \Delta(t) (\alpha - r) e^{-rt} S(t) dt + \Delta(t) \sigma e^{-rt} S(t) dW(t)
\end{align}

\noindent 6) Assume the option value is $c(t,S(t))$ and we apply Ito's formula\\
\begin{align*}
	& d(e^{-rt } c(t, S(t)) \\
= & e^{-rt} [- r c(t, S(t)) + c_t(t, S(t)) + \alpha S(t) \frac{\partial c(t, S(t))}{\partial S(t)}  +\frac{1}{2} \sigma^2 S^2(t) \frac{\partial^2 c(t, S(t))}{\partial S^2(t)} ] dt\\
  & +e^{-rt} \sigma S(t)  \frac{\partial c(t, S(t))}{\partial S(t)} dW(t)\\
\end{align*}
7)\noindent	Now equate Equation in 5) and 6), we get\\
dW(t) term:
\begin{align*}
	\Delta(t) = \frac{\partial c(t,S(t))}{\partial S(t)} \\	
\end{align*}
dt term:
\begin{align}\label{BSM}
	rc(t, S)  = c_t (t, S(t)) 
	+ r S(t) \frac{\partial c(t, S(t))}{\partial S(t)}+ \frac{1}{2} \sigma^2 S(t) \frac{\partial^2 c(t, S(t))}{\partial S^2(t)}  
\end{align}
which is known as Black-Scholes-Merton partial differential equation.\\
The terminal condition the equation satisfies for call option is
\begin{align*}
	c(T,S) = (S(T)-K)^+
\end{align*}
Similarly, for put option
\begin{align*}
	p(T,S) = (K-S(T))^+
\end{align*}
\subsection{Martingale Approach}
In risk-neutral measure, we write the stock price as
\begin{align*}
	dS(t) = rS(t) dt + \sigma S(t) d \tilde W(t) 
\end{align*}
Where $\tilde W(t)$ is a standard Brownian motion under risk-neutral measure. So by subsituting $\alpha = r$ in Eq. \ref{discounted X}, we have
\begin{align*}
 d(e^{- r t} X(t)) 
 =  \Delta(t) \sigma e^{-rt} S(t) d \tilde W(t)
\end{align*}
As the expecation of $dW(t)$ is 0, the expectation of discounted value of the portifolio does not change with time, which implies the discounted value of the portifolio is a martingale. Using this martingale property, we can get the value of the portfolio at time t 
\begin{align*}
	X(t) = \tilde E[e^{-r(T-t)}X(T)| F(t)]
\end{align*}
To find the value of the option at time t, we use the replicating strategy, in which we replicate the payoff of option $g(T)$ at time T using portfolio $X(T)$ by setting $X(T) = g(T)$.
Based on martingale property of X(t), the option price $c(t, S(t))$ is
\begin{align*}
	c(t, S(t)) = X(t) = \tilde E[e^{-r(T-t)}X(T)| F(t)]= \tilde E[e^{-r(T-t)}g(T)| F(t)]
\end{align*}
\subsection{Connection to Faynman-Kac formula}
From above, we know
\begin{align}
	c(t, S(t)) = \tilde E[e^{-r(T-t)}g(T)| F(t)] = \tilde E[e^{-r(T-t)}g(S(T),T)| F(t)] \label{rn}
\end{align}
Based on Faynman-Kac formula, there is a function $c(t,S(t))$ which must satisfy discounted partial differential equation 
\begin{align*}
	c_t(t,S) + rS c_S(t,S) + \frac{1}{2} \sigma^2 S^2 c_{SS}(t,S) = rc(t,S)
\end{align*}
Where $c(T,S(T)) = g(S(T), T)$. This is the exactly the Black-Scholes-Merton equation that we derived as in Eq. \ref{BSM}. Now we have seen two ways of showing the Black-Scholes-Merton(BSM) equation. 
One way is to reproduce the payoff of the option using a portfolio that consists of a 
saving account. Another way is based on the risk-neutral pricing formula and Feynman-Kac formula. 
These two ways are equivalent. Because under risk-neutral measure, the payoff of a derivative is the same as a saving account, which imply we are able to reproduce the payoff using portfolio that consisting of a saving account.
\subsection{Black-Scholes-Merton Model: Analytic Solution for European Option}
{\bf1. European call option}\\
For European call option with payoff to be $V(T) = max(S(T) - K, 0)$, with K as strike price, let us assume constant volatility $\sigma$, and constant interest rate r. 
Then we can obtain the solution to the BSM equation with martingale property without bothering solving the complex parital
differential equation. The call option value satisfies
\begin{align*}
	c(t, S(t)) = \tilde E[e^{-r(T-t)}(S(T)-K)^+|F(t)]
\end{align*}
We write
\begin{align*}
	S(T) = S(t) exp\{\sigma(\tilde W(T) -\tilde W(t)) + (r - \frac{1}{2} \sigma^2) \tau\} \\
	     = S(t) exp\{-\sigma \sqrt{\tau} Y + (r - \frac{1}{2}\sigma^2)\tau\}
\end{align*}
Where Y is the stardard normal random variable and $\tau = T - t$ is the time to expiration. 
\begin{align*}
        Y = -\frac{\tilde W(T) - \tilde W(t)}{\sqrt{T - t}}
\end{align*}
So we see that $S(T)$ is the product of the $F(t)$ measurable random variable S(t) and random variable
\begin{align*}
        exp\{-\sigma \sqrt{\tau} Y +(r - \frac{1}{2} \sigma^2) \tau \}
\end{align*}
Which is independent of $F(t)$.
Therefore based on risk-neutral pricing formula[\ref{rn}]
\begin{align*}
        c(t,x) = \tilde E[e^{-r\tau}(x exp\{ -\sigma \sqrt{\tau} Y + (r - \frac{1}{2} \sigma^2)\tau\} -K)^+]\\
        = \frac{1}{\sqrt{2\pi}} \int_{-\infty}^{\infty} e^{-\tau r}(x exp\{-\sigma \sqrt{\tau} y
        +(r -\frac{1}{2}\sigma^2)\tau \} -K)^+ e^{-\frac{1}{2}y^2} dy
\end{align*}
After a little bit of math with integration, we have the solution to the Black-Scholes-Merton model for European call option
\begin{align*}
	c(\tau,x; K, r, \sigma) = xN(d_1(\tau,x)) - e^{-r\tau}KN(d_2(\tau,x))
\end{align*}
Where
\begin{align*}
	d_1 = \frac{1}{\sigma \sqrt{\tau}}[ln(\frac{S_t}{K}) + (r+ \frac{\sigma^2}{2})\tau] \\
	d_2 = d_1 - \sigma \sqrt{\tau}
\end{align*}
N() is the cumulative distribution function of the standard normal distribution
{\bf 2. European put option}\\
The payoff for the European put option is $V(T) = max(K - S(T), 0)$, we can follow a similiar derivation and get the formula for put option
\begin{align*}
	p(\tau,x; K, r, \sigma) = Ke^{-r\tau}N(-d_2)-xN(-d_1)
\end{align*}
{\bf 3. Options based on dividend-paying stock}\\
The value of dividend-paying stock consists of two parts. One is the value of the stock, the other one is the value of dividend. Suppose the dividend rate is a, then the change of value of dividend-paying stock over time dt is $dS(t) + aS(t)dt$. In order to make the discounted value a martingale, we require 
\begin{align*}
	\frac{dS(t) + aS(t)dt}{S(t)} = rdt + \sigma d \tilde W(t)
\end{align*}
so
\begin{align*}
	dS(t) = (r-a) S(t)dt + \sigma S(t) d \tilde W(t)
\end{align*}
\begin{align*}
	S(T) = S(t) exp\{\sigma(\tilde W(T) -\tilde W(t)) + (r - a - \frac{1}{2} \sigma^2) \tau\} \\
\end{align*}
Following similar derivation, for call option we can get
\begin{align*}
	c(\tau,x; K, r, \sigma) = xe^{-a\tau} N(d_1(\tau,x)) - e^{-r\tau} K N(d_2(\tau,x))
\end{align*}
\begin{align*}
	p(\tau,x; K, r, \sigma) = Ke^{-r\tau} N(-d_2)-xe^{-a \tau}N(-d_1)
\end{align*}
{\bf 4. Boundary conditons}\\
Using the solution $c(t,x)$ and $p(t,x)$, we can easily check the boundary conditions when
time t approaches to expiration time T.\\
As we know
\begin{align*}
	d_1 = \frac{1}{\sigma \sqrt{\tau}}ln(\frac{S}{K}) 
	+ \frac{1}{\sigma}(r+\frac{\sigma^2}{2}\sqrt{\tau})
\end{align*}
When $\tau \to 0$, the second term decays much faster, so it vanishes. When $S>K$, $d_1$ goes to infinity, when $S<K$, $d_1$ goes to negative infinity.
Therefore, when $S>K$
\begin{align*}
	c(t,x) = S*N(+\infty) - K*N(+\infty) = S-K
\end{align*}
Therefore, when $S<K$
\begin{align*}
	c(t,x) = S*N(-\infty) - K*N(-\infty) = 0-0 = 0
\end{align*}
{\bf 5. Examples}\\
The following graphs show the change of option price with respect to different parameters.
\\
\\
\\
\\
\includegraphics[scale = 0.5]{option_price1.eps}\\
\\
\\
\includegraphics[scale = 0.5]{option_price2.eps}\\
{\bf 6. Alternative formulation}\\
If we introduce $F = e^{(r-a)\tau} S$, which is the forward price of the asset S. Then the equation pricing equation becomes
\begin{align*}
	C(F,\tau)= D[N(d_+)F - N(d_-)K] \\
	P(F,\tau)= D[N(-d_-)K - N(-d_+)F] \\
	d_{+/-} = \frac{1}{\sigma \sqrt{\tau}}[ln(\frac{F}{K})+/-\frac{1}{2}\sigma^2 \tau] \\
\end{align*}
The variables are:\\
$\tau = T - t$ is the time to expiry\\
$D = e^{-r\tau}$ is the discount factor \\
\subsection{Heston Stochasic Volatility Model}
The Black-Scholes equation assumes the volatility is constant, which is the ideal case and not practical in the real market. The Heston model\cite{heston} assumes the volatility to follow a stochastic process. Suppose a stock price under risk-neutral measure is governed by
\begin{align}
	dS(t) = rS(t)dt + \sqrt{V(t)} S(t) d \tilde W_1(t) 
\end{align}
and the volatility itself is governed by the equation
\begin{align}
	dV(t) & = \kappa (\theta -V(t))dt + \sigma \sqrt{V(t)} d \tilde W_2(t) \label{heston_volatility}
\end{align}
Where 
\begin{align*}
	d\tilde W_1(t) d\tilde W_2(t) = \rho dt
\end{align*}
The parameter $\theta$ can be viewed as a long-term average variance. And the instantaneous variance is pulled elastically towards the long-term variance by a speed controlled by parameter $b$. To solve the option pricing for this model, we apply the same martingale property under risk-neutral measure. The value of the European call option is
\begin{align*}
	C(t, S(t)) = \tilde E[e^{-r(T-t)}V(T)| F(t)] = \tilde E[e^{-r(T-t)}(S_T - K)^{+}| F(t)]
\end{align*}
Let $x_T = ln(S_T)$, and $\tau = T - t$, then, and we assume the pdf of $ln(x_T)$ given $x_t$is $p(x_T | x_t)$, then
\begin{align}
	C(t, S(t)) & = e^{ -r \tau } \int_{lnK}^{\infty} (e^{x_T} - K) p(x_T| x_t) dx_T \nonumber \\ 
		   & = e^{-r \tau}\int_{lnK}^{\infty} e^{x_T} pdf(x_T| x_t) dx_T 
		   - e^{-r\tau} K \int_{lnK}^{\infty}  p(x_T | x_t) dx_T \nonumber \\
		   & = S_0 I_1 -  e^{-r \tau} K I_2 \label{heston_solution_form}
\end{align}
where 
\begin{align}
	I_1 = \frac{1}{S_0} e^{-r \tau}\int_{lnK}^{\infty} e^{x_T} p(x_T | x_t) dx_T \label{I_1}
\end{align}
\begin{align}
	I_2 = \int_{lnK}^{\infty}  p(x_T | x_t) dx_T \label{I_2}
\end{align}
So as long as we know the pdf of $x_T$, we can solve these two integral and get $C(t, S(t))$. But unlike in the BSM model, the analytical form of pdf of x does not exist for Heston model. Fortunately, literauture shows the characteristic function of x exists. Heston \cite{heston} proposed a solution using characteristic function. We list the result here and we will elaborate the derivation in the Appendix. \\
Suppose $\phi(u, x_t)$ is the characteristic function of $p(x_T| x_t)$, Heston shows $\phi(u,x_t)$ takes the form of
\begin{align}
	\phi(u) = exp(C(T-t, u) + D(T-t, u)V_t + iux_t) \label{heston_characteristic}
\end{align}
Let $\tau = T - t$. The solution of C and D are
\begin{align} 
	C(\tau, u) = iru\tau + \frac{\kappa \theta}{\sigma^2}
	[(\kappa - i\rho \sigma u + d)\tau - 2ln(\frac{1 - g e^{d\tau}}{1 - g})] \label{heston_C}
\end{align}
\begin{align} 
	D(\tau, u) = \frac{\kappa - i\rho \sigma u + d}{\sigma^2} (\frac{1 - e^{d\tau}}{1-ge^{d\tau}})
		\label{heston_D}
\end{align}
Where
\begin{align*}
	d = \sqrt{(i\rho \sigma u - \kappa)^2 + \sigma^2(i  u + u^2)} \\
	g = \frac{\kappa - i \rho \sigma u + d}{\kappa - i \rho \sigma u -d} \\
\end{align*}
then using inverse Fourier transform
\begin{align*}
	I_1 = \frac{1}{\pi} \int_{0}^{\infty}\mathcal Re(\frac{e^{-iuln(K)}\phi(u-i)}{iu\phi(-i)})du +\frac{1}{2} \\
	I_2 = \frac{1}{\pi} \int_{0}^{\infty}\mathcal Re( \frac{e^{-i u lnK}}{iu} \phi(u))  du + \frac{1}{2} \\
\end{align*}
With $I_1$ and $I_2$, we can have the solution of the value of the option using Eq. \ref{heston_solution_form}.
\subsection{Jump Diffusion Model}
The BSM model and the Heston model assumes the asset prices follows the stochastic process driven by Brownian motion. Under this assumption, the asset price is continuous in time. The jump diffusion model extends the BSM model and Heston model by assuming asset price has discrete jump in time. Therefore in jump diffusion model, the stochastic process contains a continuous Brownian motion process and a discrete jump process.\\

\noindent{\bf 1. Number of jumps during per unit time: Possion distribution}\\
The number of jump should be either zero or a positive integer. Let N be the number of jump per unit of time and k be a nonnegative integer. Then the probability of $N = k$ should satisfies
\begin{align*}
	\sum_{k = 0}^\infty P(N = k) = 1
\end{align*}
In order to find the distribution, we borrow the idea of Taylor's expansion. We consider a function $e^{\lambda}$, its Taylor's expansion is
\begin{align*}
	e^{\lambda} = \sum_{k = 0}^\infty \frac{\lambda^k}{k!}
\end{align*}
Dividing $e^{\lambda}$ on both sides, we can
\begin{align*}
	1 = \sum_{k = 0}^\infty \frac{\lambda^k}{k!}e^{-\lambda} 
\end{align*}
So we can assign the probability
\begin{align*}
P(N = k) = \frac{\lambda^k}{k!}e^{-\lambda}
\end{align*}
This is the well-known Possion distribution. It is easy to show Possion distribution has mean and variance equal to $\lambda$. So $\lambda$ can be intepreted as the average number of jumps per unit of time.\\

\noindent{\bf 2. Number of jumps during time interval $\Delta t$: Possion process}\\
Now we consider the number of jumps in a given time interval $\Delta t$, and we call it $\Delta N$. The average jump during $\Delta t$ is $\lambda \Delta t$. So we can get the probability distribution by substitude $\lambda \Delta t$ to $\lambda$
\begin{align*}
	P(\Delta N = k) = \frac{(\lambda \Delta t)^k}{k!}e^{-\lambda \Delta t}
\end{align*}
The mean of $\Delta N$ is $\lambda \Delta t$.\\

Let $\Delta t$ be really small time interval $dt$, and from above we see
\begin{align*}
	P(dN = 0) = e^{-\lambda dt} \approx 1 - \lambda dt \\
	P(dN = 1) = \lambda dt e^{-\lambda dt} \approx \lambda dt (1 - \lambda dt) \approx \lambda dt \\
	P(dN = 2) = (-\lambda dt)^2 e^{- \lambda dt} \approx 0 \\
\end{align*}
This makes perfectly sense, as during an infinitesimal time interval, the jump can either not happen or happen only once.\\

We define $S_k$ is the time when the kth jump occurs and we assume $S_0 = 0$. Then the Possion process is
\begin{align*}
	N(t) = k  \text{ if } S_k \leq t < S_{k+1}
\end{align*}
With $E[N(t)] = \lambda t$.
Note the Poisson process defined above is right-continuous.\\

\noindent{\bf 3. Compensated Poisson process}\\
The Poisson process has a mean that is a function of time. As time evolves, the process has a non-zero drift so it is not a martingale. We define a compensated Poission process $M(t)$ which obeys the martingale property
\begin{align*}
	M(t) = N(t) - \lambda t \\
	E[M(t)|F(s)] = M(s)
\end{align*}

\noindent{\bf 4. Compound Poisson process}\\
In the above definition, we assume the jump size in the Possion process is 1. Now we allow the jump size to be random. Let N(t) be a Poisson process with mean $\lambda$ and $Y_i$ be a sequence of random variable with mean $E[Y] = m$. We define compound Poisson process
\begin{align*}
	Q(t) = \sum_{i=1}^{N(t)} Y_i
\end{align*}
The number of jumps follows Poisson distribution, and at each jump, the size of the jump is $Y_i$. In other words, the first jump size is $Y_1$ and the second jump size is $Y_2$, etc.

The mean of the compound Poisson process is the product of the number of jumps and the size of the jumps, as these two are independent.
\begin{align*}
	EQ(t) = m \lambda t
\end{align*}

We can also define a compensated compound Poisson process
\begin{align*}
	\tilde M(t) = Q(t) - m \lambda t
\end{align*}
And this is a martingale.\\

\noindent{\bf 5. Geometric Possion process with constant jump size}\\
In the compound Possion process, let the jump size be a constant $y$. When jump occurs, we have 
\begin{align*}
	Q(t_i) = Q(t_{i-}) + y 
\end{align*}
The asset value in the financial market follows the geometric Possion process. Let S(t) be the asset price, let
\begin{align*}
	& S(t_i) = S(t_{i-}) y \\
	& \frac{S(t_i) - S(t_{i-})}{S(t_{i-})} =  y - 1 \\
	&  \Delta S(t_i) =  (y - 1) S(t_{i-}) \Delta N(t)  \\
\end{align*}
Where $\Delta N(t) = 1$ when jump occurs, $0$ otherwise. When $N(t) = 1$, there is one jump from time zero up to t, so $S(t) = yS(0)$. When $N(t) = 2$, $S(t) = y^2 S(0)$. So for any abitrary $N(t)$
\begin{align*}
	S(t) = S(0)y^{N(t)} 
\end{align*}
In order to fulfill the martingale condition, we write
\begin{align*}
	dS(t) = (y - 1)S(t) dN(t) - (y - 1) \lambda S(t) dt
\end{align*}
Its integral form is
\begin{align*}
	S(t) = S(0)y^{N(t)} exp(- (y - 1) \lambda t) 
\end{align*}
\noindent{\bf 6. Geometric Poisson process with log-normal jump size: Bates jump diffusion model}\\
If the jump size Y is random in the geometric Poisson process, then to model the asset price, we need to modify
the last equation by changing $y^{N(t)}$ to $\Pi_{i=1}^{N(t)} Y_i$, and $y - 1$ to E[Y] - 1. 
\begin{align*}
	S(t) = S(0)\Pi_{i=1}^{N(t)} Y_i exp(- (E[Y] - 1) \lambda t) 
\end{align*}
We need to model the jump size $Y_i$. $Y_i$ is a strictly positive random variable so a good candidate is the exponential of normal random variable which is log-nomal random variable. If we have a normal distributed random variable $J \sim N(\nu, \delta^2)$, and let $Y$ be $e^{J}$. Then $Y$ follows log-normal distribution with mean $e^{\nu + \frac{1}{2}\delta^2}$. We can write S(t) using $J$
\begin{align*}
	S(t) = S(0) exp{\sum_i^{N(t)} J_i} exp(-(e^{\nu + \frac{1}{2}\delta^2}-1) \lambda t) 
\end{align*}
Let $Z = \sum_i^{N(t)} J_i$, which is a sum of normal random variable. Then $Z \sim Normal(N(t)\nu, N(t)\delta^2)$. So
\begin{align*}
	S(t) = S(0) exp{(Z -(e^{\nu + \frac{1}{2}\delta^2}-1) \lambda t)} 
\end{align*}
Where $ Z \sim Normal(N(t)\nu, N(t)\delta^2)$ given $N(t) \sim Poisson(\lambda t)$.\\
\section{Monte Carlo Simulation Processes}
In simulation, we decompose the time evolvement of an asset price into three components: drift, diffusion, jump. The
drift term is dt term, the diffusion term has Brownian motion component, the jump term has Possion component. Let us look at the following examples. \\ 
1. BSM process\\
In BSM process, the asset price follows
\begin{align*}
	S(t) = S(0)exp((r - \frac{1}{2} \sigma^2 ) dt + \sigma dW(t)) \\
\end{align*}
The drift term is clearly $r - \frac{1}{2} \sigma^2$ for any given dt.  For the diffusion term, we need to generate W(t).
We know the W(t) is a Normal random variable with mean 0 and variance t. So suppose we generate a Gaussian random variable $\hat W$, it turns out $W = \sqrt{t} \hat W$ is normally distributed with variance t. 
\begin{align*}
	& \mu = r - \frac{1}{2} \sigma^2\\
	& S^{(t + dt)} = S^{(t)}exp(\mu dt + \sigma \sqrt{dt} \hat W) \\
\end{align*}
2. Heston process\\
The Heston model states
\begin{align*}
        dS(t) = rS(t)dt + \sqrt{V(t)} S(t) \tilde dW_1(t) \\
        dV(t) = \kappa (\theta - V(t))dt + \sigma \sqrt{V(t)} \tilde dW_2(t) \\
        \tilde dW_1(t) \tilde dW_2(t) = \rho dt \\
\end{align*}
{\bf a. Generating two Brownian motions with correlation. }\\
To simulate Heston process needs to generate two Gaussian random variables that has correlation $\rho$, we do this by first generate two independent Gaussian random variables $W_1$, $W_2$, then
\begin{align*}
	W_1^{'} = \hat W_1 \\
	W_2^{'} = \rho \hat W_1 + \sqrt{1 - \rho^2} \hat W_2 \\
\end{align*}
We can easily check the mean of $W_2^{'}$
\begin{align*}
	&E[W_2^{'}] = \rho E[W_1] + \sqrt{1 - \rho^2} E[W_2] = 0\\
	&Var[W_2^{'}] = \rho^2 Var[W_1] + (1 - \rho^2) Var[W_2] = \rho^2 + 1 - \rho^2 = 1 \\
\end{align*}
\begin{align*}
	cor(W_1^{'}, W_2^{'}) & = \frac{E[W_1^{'}W_2^{'}]}{\sqrt{Var[W_1^{'}]}\sqrt{Var[W_2^{'}]}}\\
		      & = E[W_1 (\rho W_1 +\sqrt{1 - \rho^2})W_2] \\
		      & = \rho E[W_1^2] + \sqrt{1 - \rho^2} E[W_1 W_2] \\
		      & = \rho \\
\end{align*}
The last step uses the fact $W_1$ and $W_2$ are independent, so $E[W_1 W_2] = E[W_1] E[W_2] = 0$.\\
{\bf b. Discretization schemes and coping with negative V(t). } \\
The Heston model setting provides a non-negative V(t). This can be seen when V(t) is positively moving close to zero, the drift term $adt$ pulls the V(t) up and avoid $V(t)$ to cross zero. However, in discretized version $V(t)$ may attain negative values. There exists several methods to deal with this issue.\\
(1) Absorption: Keep positive part of the previous $V(t)$ and use it to calculate next step $V(t+dt)$ and X(t+dt)\\
\begin{align*}
	V^{(t + dt)} = V^{+(t)} + \kappa (\theta -  V^{+(t)}) \sqrt{dt} + \sigma \sqrt{V^{+(t)}} dt (\rho \hat W_1
	+ \sqrt{1 - \rho^2} \hat W_2)
\end{align*}
(2) Relection: Keep the absolute value of the previous $V(t)$ and use it to calculate next step $V(t+dt)$ and X(t+dt)\\
\begin{align*}
	V^{(t + dt)} = |V^{(t)}| + \kappa (\theta -  |V^{(t)}|) \sqrt{dt} + \sigma \sqrt{|V^{(t)}|}  dt (\rho \hat W_1
	+ \sqrt{1 - \rho^2} \hat W_2)
\end{align*}
(3) Partial truncation: Using the posivive part in diffusion term of $V(t+dt)$ and in $X(t + dt)$\\
\begin{align*}
	V^{(t + dt)} = V^{(t)} + \kappa(\theta -  V^{(t)}) \sqrt{dt} + \sigma \sqrt{V^{+(t)}} dt (\rho \hat W_1
	+ \sqrt{1 - \rho^2} \hat W_2)
\end{align*}
(4) Full truncation\cite{fulltruncation}: Using the positive part in drift and diffusion terms of $V(t + dt)$, and in $X(t + dt)$. 
This scheme is proved to have the lowest bias.
\begin{align}
	V^{(t + dt)} = V^{(t)} + \kappa(\theta -  V^{+(t)}) \sqrt{dt} + \sigma \sqrt{V^{+(t)}} dt (\rho \hat W_1
	+ \sqrt{1 - \rho^2} \hat W_2)  \label{full_truncation}
\end{align}
Together with formula for the drift and asset price, we write
\begin{align*}
	& \mu = r - \frac{1}{2} (V^{+(t)})\\
	& S^{(t + dt)} = S^{(t)}exp(\mu dt + \sqrt{V^{+(t)}} \sqrt{dt} W_1) \\
	& V^{(t + dt)} = V^{(t)} + \kappa (\theta - b V^{+(t)}) \sqrt{dt} + \sigma \sqrt{V^{+(t)}} dt (\rho \hat W_1
	+ \sqrt{1 - \rho^2} \hat W_2) 
\end{align*}
All these above belong to the Euler discretization schemes which lead to more or less discretization errors. There exists an exact but computationaly expensive simulation scheme proposed by Broadie and Kaya\cite{exact_heston}. Their method is based on the fact that the transition probability of $V(t)$ given $V(u)$（$u < t$) is chi-square distribution, which can be proved using Kolmogorov's partial differential equation.\\ %Then we follow the following steps:\\
%(1) Generate a sample from the distribution of $V_t$ given $V_u$.
%(2) Generate a sample from the distribution of $\int_u^t V_s ds$ given $V_t$ and $V_u$.
%t √
%Step 3. Recover u V s dW s 1 from (7) given V t , V u , andtV ds.u s
%Step 4. √ Generate a sample from the distribution of S t
%t
%t
%given u V s dW s 1 and u V s ds.
3. Bates process\\
\begin{align*}
	& \mu = r - \frac{1}{2} (V^{+(t)}) - \lambda (e^{\nu + \frac{1}{2}\delta^2}  -1) \\
	& S^{(t + dt)} = S^{(t)}exp(\mu dt  + \sqrt{V^{+(t)}} \sqrt{dt} dW_1 
	   + (\nu_*N+\delta^2*\sqrt{N})*dW_3)\\
	& V^{(t + dt)} = V^{(t)} + \kappa(\theta -  V^{+(t)}) dt + \sigma \sqrt{V^{+(t)}} dt (\rho \hat W_1
	+ \sqrt{1 - \rho^2} \hat W_2 )
\end{align*}
\section{Simulation for American Option}
American Option can be exercised at any time. So in Monte Carlo Simulation, for each path we need to determine the stopping time, in other words, time for the option to be exerciesed. For each sample path at each time step point, we need to compare the current payoff value with the value to keep holding this option. If the current payoff value is great than the value to keep holding this option, we choose to exercise, otherwise we hold it. To evaluate the value to hold this option requires another Monte Carlo simulation, so the simulation for American option has a "Monte Carlo on Monte Carlo feature", and this is very computationally expensive. To see why it is expensive, consider the case of M samples and we are at time step 1. To determine the value of holding the option, we need generate another Monte Carlo simulation which has M sample paths. As we move on the time step, each step needs the number of sample path M times the previous one, therefore, the total number of Monte Carlo simulation grows exponentially as time step grows. 

However, this does not mean there is no feasible way to evaluate American options. One idea is to avoid doing additional Monte Carlo simulation at each step to determine the value of holding the option and utilizing the simulation path of the European options. LongStaff\cite{americanoption} proposed an algorithm to determine the stopping time by using least square regression and here we briefly outline the algorithm.

Let us assume the option has a payoff function $h(S, K)$, where K is strike price.
The algorhim simply has two parts. The first part is to follow the standard simulation scheme for European options. We generate M samples path from timestep 0 to timestep T. For each sample, the asset price forms a price path from $i = 0$ to $T$ and the current asset price at a given timestep i is $S^{(m)}_i$, where $0 \leq i \leq T$. We define a discount factor $D_{i,j}$ to discount the asset price at time j to time t. For example $D_{13} = e^{-(3-1)r} = e^{-2r}$. 
Then the second part is to define a stopping time $\tau^{(m)}$ for each path. \\
(1) set $\tau^{(m)}$ to T for each sample path m.\\
(2) for t from T - 1 to 1:\\
\indent  \indent  for each sample:\\
\indent  \indent \indent(2a) calculate discount payoff value: $DV^{(m)} = D_{t, \tau} h(S^{(m)}_\tau, K) $\\
\indent  \indent \indent(2b) calculate the current payoff value: $h(S^{(m)}_t)$\\
\indent	 \indent \indent(2c) regress $DV$ on ${S_t}$ using least square and get estimated \\
\indent  \indent \indent    discount payoff value $EDV = f(S_t)$\\
\indent	 \indent \indent(2d) if $h(S^{(m)}_t) > EDV^{(m)}(X^{(m)}_i)$, \\
\indent  \indent \indent     this means we can exercise the option, then upate $\tau^{(m)} = t$.\\
(3) for each path calculate the present value of the payoff at stopping time $\tau$ \\
$PV^{(m)} = D_{t, \tau} h(S^{(m)}_\tau, K)$\\
(4) average $PV^{(m)}$ to get the price of the option\\
\section{Result}
{\bf Simulation of option value with BSM model using both analytical(ANAL) and Monte Carlo(MC).} We calcuate the values of  option of different types and styles listed in Table. \ref{option_bsm}. For MC method, we choose 100 timesteps per year and 100000 sample paths. For Eurpoean style, we also compare the result with the analytical one. Our data matches the data presented in \cite{americanoption}. The result verified that for European option, there is no incentive to exercise early as the payoff function given the risk-neutral measure is a submartingale and has the trend to increase(Proof in Appendix). For American put option, we observe that the NPV is larger than the NPV of European option across different strike prices and volatilities, so the early exercise value is clearly visible.

\begin{table}
	\begin{tabular} { l  c  c   c  c  c   c    c       c        c  }
		Style 	 & Type & S  & K & r & Time &$\sigma$ & NPV(ANAL) & NPV(MC) &Ref\cite{americanoption}\\
	\hline 
		European & Call & 36.0 & 40 &2 & 0.06 & 0.2 & 4.28 & 4.27(3) & \\
		American & Call & 36.0 & 40 &2 & 0.06 & 0.2 & N/A  & 4.28(3) &\\
		European & Put  & 36.0 & 40 &2 & 0.06 & 0.2 & 3.76 & 3.76(2) &\\
		American & Put  & 36.0 & 40 &2 & 0.06 & 0.2 & N/A  & 4.81(3) & 4.82(1)\\
		European & Call & 36.0 & 40 &2 & 0.06 & 0.4 & 8.22 & 8.27(6) &\\
		American & Call & 36.0 & 40 &2 & 0.06 & 0.4 & N/A  & 8.23(6) &\\
		European & Put  & 36.0 & 40 &2 & 0.06 & 0.4 & 7.70 & 7.70(4) &\\
		American & Put  & 36.0 & 40 &2 & 0.06 & 0.4 & N/A  & 8.50(3) & 8.49(2)\\
		European & Call & 44.0 & 40 &2 & 0.06 & 0.2 & 9.95 & 9.93(5) &\\
		American & Call & 44.0 & 40 &2 & 0.06 & 0.2 & N/A  & 9.91(5) &\\
		European & Put  & 44.0 & 40 &2 & 0.06 & 0.2 & 1.43 & 1.44(1) &\\
		American & Put  & 44.0 & 40 &2 & 0.06 & 0.2 & N/A  & 1.67(3) & 1.68(1)\\
		European & Call & 44.0 & 40 &2 & 0.06 & 0.4 & 13.73 & 13.81(9) &\\
		American & Call & 44.0 & 40 &2 & 0.06 & 0.4 & N/A  & 13.75(8) &\\
		European & Put  & 44.0 & 40 &2 & 0.06 & 0.4 & 5.20 &  5.21(3)&\\
		American & Put  & 44.0 & 40 &2 & 0.06 & 0.4 & N/A  &  5.65(3)& 5.62(2)\\
	\hline
	\end{tabular}\\
\caption{Simulation result of different options using BSM model.
	S: Underlying Asset Price. K: strike price. r: interest rate. Time: time to expiration.
	$\sigma$: volatility. NPV(ANAL): Analytical result of net present value.
	NPV(MC): Monte Carlo result of net present value.}\label{option_bsm}
\end{table}


{\bf Simulation of option value with Heston model using both analytical(ANAL) and Monte Carlo(MC)} We calcluate the values of different options using Heston model and list
 the result in Table \ref{option_heston}. For the parameters, $\theta$ is chosen to be the square of the initial volatility. And $\rho$ is chosen to be a negative value because there is negatived correlated relationship between the change of the stock price and the change of volatility in Ref. \ref{geske}, Eq. 17.In the table, with each set of parameters, we present two ways of calculation. The first one is using characteristic function inversion defined in Eq \ref{heston_characteristic}, Eq \ref{heston_C}, Eq \ref{heston_D} and we label it as NPV(ANAL). The second is Monte Carlo labeled as NPV(MC). In Monte Carlo method, we use full truncation scheme to prevent $V(t)$ to be negative. 40 time steps per year and 10000 samples are used. We see that these two methods agree pretty well.

\begin{table}
	\begin{tabular} { l    c c  c  c  c    c c c    c       c          }
		 Type & S  & K & r& Time & $\kappa$& $\theta$ & $\sigma$ & $\rho$ & NPV(ANAL) & NPV(MC) \\
	\hline 
		 Call & 36.0 & 40 & 0.06&   2 &  2 &  0.04  & 0.1& -0.5 & 4.26 & 4.26(1)  \\
		 Put  & 36.0 & 40 & 0.06&   2 &  2 &  0.04  & 0.1& -0.5 & 3.74 & 3.73(1) \\
		 Call & 36.0 & 40 & 0.06&   2 &  2 &  0.16  & 0.1& -0.5 & 8.18 & 8.19(3) \\
		 Put  & 36.0 & 40 & 0.06&   2 &  2 &  0.16  & 0.1& -0.5 & 7.65 & 7.64(2) \\
		 Call & 44.0 & 40 & 0.06&   2 &  2 &  0.04  & 0.1& -0.5 & 10.01 & 10.03(2) \\
		 Put  & 44.0 & 40 & 0.06&   2 &  2 &  0.04  & 0.1& -0.5 & 1.49 & 1.48(1) \\
		 Call & 44.0 & 40 & 0.06&   2 &  2 &  0.16  & 0.1& -0.5 & 13.73 & 13.75(4) \\
		 Put  & 44.0 & 40 & 0.06&   2 &  2 &  0.16  & 0.1& -0.5 & 5.20 &  5.18(1)\\
	\hline
	\end{tabular}\\
\caption{Simulation result of European options based on Heston model.
	S: Underlying Asset Price. K: strike price. r: interest rate. $\kappa$, $\theta$, $\sigma$, $\rho$ are defined in Eq \ref{heston_volatility}.
	 NPV(ANAL): Analytical result of net present value.
	NPV(MC): Monte Carlo result of net present value.}\label{option_heston}
\end{table}
\appendix
\section{Applendices}
\subsection{Semi-analytical Solution to Heston Model}
\subsubsection{Solve for the Characteristic Function of $ln(S_t)$}
The stochastic process of $ln(S_t)$ can be obtained by Ito's formula
\begin{align*}
	d(ln(S_t)) & = \frac{ln(S_t)}{S_t} dS_t - \frac{1}{2S_t^2} (dS_t)^2 \\
		   & = \frac{1}{S_t} (rS(t)dt + \sqrt{V(t)}S(t)dW_1(t))
		      - \frac{1}{2S_t^2} (rS(t)dt + \sqrt{V(t)}S(t)dW_1(t))^2 \\
\end{align*}
We only would like to keep the first-order terms, so
\begin{align*}
	d(ln(S_t)) & = (r dt + \sqrt{V(t)}dW_1(t)) - \frac{1}{2}V dt \\
		  & = (r - \frac{1}{2}V(t)) dt + \sqrt{V(t)} dW_1(t) \\
\end{align*}
Let $x_t = ln(S_t)$, the characteristic function of $x_T$ given $x_t$ is defined as
\begin{align*}
	\phi(u, t, x_t) = E[e^{iuX_T}|x_t]
\end{align*}
with $\phi(u, T, X_T) = e^{iuX_T}$. Then based on Feynman-Kac formula, $\phi(u, t, x_t)$ satisfies the partial
differential equation
\begin{align}
	\frac{\partial \phi(u, t, x_t)}{\partial t} + (r - \frac{1}{2}V_t)\frac{\partial \phi(u, t, x_t)}{\partial x_t} 
	+ (\kappa(\theta-V_t)) \frac{\partial \phi(u, t, x_t)}{ \partial V_t}   \nonumber \\ 
	+ \frac{1}{2}  V_t \frac{\partial^2 \phi(u, t, x_t)}{ \partial x_t \partial x_t } 
	+ \rho \sigma V_t \frac{\partial^2 \phi(u, t, x_t)}{ \partial x_t \partial V_t}
	+\frac{1}{2} \sigma^2 V_t \frac{\partial^2 \phi(u, t, x_t)}{ \partial V_t \partial V_t}  = 0 \label{characteristic_pde1}
\end{align}
We guess $\phi(u)$ has the form 
\begin{align}
	\phi(u,t, x) = exp(C(T-t, u) + D(T-t, u)V_t + iux_t) \label{phi}
\end{align}
which satisfy the terminal condition $\phi(T, x_T) = e^{iux_T}$. With Eq. \ref{phi}, we easily see
\begin{align*}
	\frac{\partial \phi(u, t, x_t)}{\partial x_t} = iu\phi(u, t, x_t) \\
	\frac{\partial^2 \phi(u, t, x_t)}{\partial x_t \partial x_t} = -u^2\phi(u, t, x_t)
\end{align*}
So Eq. \ref{characteristic_pde1} becomes
\begin{align*}	
	-\frac{\partial \phi}{\partial \tau}
	+ (r - \frac{1}{2}V)iu \phi 
	+ (\kappa(\theta-V)) \frac{\partial \phi}{\partial V}
        -\frac{1}{2}Vu^2 \phi
	+ \rho \sigma V iu \frac{\partial \phi}{\partial V}
	+\frac{1}{2} \sigma^2 V \frac{\partial^2 \phi}{\partial V^2}  = 0\\ \label{characteristic_pde}
\end{align*}
If we substitude the expression of $\phi(u, t, x)$ in Eq. \ref{phi} into Eq. \ref{characteristic_pde}, work out the derivative terms and separate the term with and without $V$, we can get the following two equations
\begin{align*}
	-\frac{\partial D}{\partial \tau} - \kappa D - \frac{1}{2}u^2 -\frac{1}{2}iu + i\rho \sigma u D
	+\frac{1}{2} \sigma^2 D^2 = 0 \\
	-\frac{\partial C}{\partial \tau} + iru + \kappa \theta D = 0
\end{align*}
These equations can be solved and we can get the expression of C and D as in Eq. \ref{heston_C} and Eq. \ref{heston_D}.
\begin{align*} 
	C(\tau, u) = iru\tau + \frac{\kappa \theta}{\sigma^2}
	[(\kappa - i\rho \sigma u + d)\tau - 2ln(\frac{1 - g e^{d\tau}}{1 - g})] 
\end{align*}
\begin{align*} 
	D(\tau, u) = \frac{\kappa - i\rho \sigma u + d}{\sigma^2} (\frac{1 - e^{d\tau}}{1-ge^{d\tau}})
\end{align*}
Where
\begin{align*}
	d = \sqrt{(i\rho \sigma u - \kappa)^2 + \sigma^2(i  u  + u^2)} \\
	g = \frac{\kappa - i \rho \sigma u + d}{\kappa - i \rho \sigma u -d} \\
\end{align*}
\subsubsection{Option Price Solution based on Characteristic Function}
From Eq. \ref{I_1} and Eq. \ref{I_2}
\begin{align*}
	I_1 = \frac{1}{S_0} e^{-r \tau}\int_{lnK}^{\infty} e^{x_T} p(x_T | x_t) dx_T 
\end{align*}
\begin{align*}
	I_2 = \int_{lnK}^{\infty}  p(x_T | x_t) dx_T 
\end{align*}
Using inverse Fourier transform, we have
\begin{align*}
	p(x) = \frac{1}{2\pi} \int_{-\infty}^{\infty} e^{-iux}  \phi(u) du
\end{align*}
Then we can write $I_2$ as
\begin{align*}
	I_2  = \int_{lnK}^{\infty}  p(x) dx
	   = \int_{lnK}^{\infty} ( \frac{1}{2\pi} \int_{-\infty}^{\infty} e^{-iux}  \phi(u) du) dx
\end{align*}
Changing the order the integration yields
\begin{align*}
	I_2 & = \frac{1}{2\pi} \int_{-\infty}^{\infty}\phi(u) (\int_{lnK}^{\infty} e^{-iux}  dx) du \\
	  & = \frac{1}{2\pi} \int_{-\infty}^{\infty}\phi(u)(\int_{-\infty}^{\infty} {\bf 1}_{x > lnK}e^{-iux}dx) du\\
\end{align*}
The inner integral is the inverse Fourier transform of a step function and the result is well-known.
\begin{align*}
	I_2 & = \frac{1}{2\pi} \int_{-\infty}^{\infty}\phi(u)( \frac{1}{iu }e^{-i u lnK} + \pi \delta(u)) du \\
	  & = \frac{1}{2\pi} \int_{-\infty}^{\infty}\phi(u)( \frac{1}{iu }e^{-i u lnK} ) du + \frac{1}{2} \\
	  & = \frac{1}{2\pi} (\int_{-\infty}^{0}\frac{1}{iu}\phi(u) e^{-i u lnK} +  \int_{0}^{\infty}\frac{1}{iu }\phi(u) e^{-i u lnK}) du + \frac{1}{2} \\
	  & = \frac{1}{2\pi} \int_{\infty}^{0}\frac{1}{i(-u)}\phi(-u) e^{i u lnK}d(-u) +\int_{0}^{\infty}\frac{1}{iu }\phi(u) e^{-i u lnK}  du + \frac{1}{2} \\
	  & = \frac{1}{2\pi} \int_{0}^{\infty}\frac{1}{i(-u)}\phi(-u) e^{i u lnK}du +\int_{0}^{\infty}\frac{1}{iu }\phi(u) e^{-i u lnK}  du + \frac{1}{2} \\
	  & = \frac{1}{2\pi} \int_{0}^{\infty}(\frac{1}{i(-u)}\phi(-u) e^{i u lnK} + \frac{1}{iu}\phi(u) e^{-i u lnK})  du + \frac{1}{2} \\
	  & = \frac{1}{2\pi} \int_{0}^{\infty}\mathcal Re( 2\frac{1}{iu }\phi(u) e^{-i u lnK})  du + \frac{1}{2} \\
	  & = \frac{1}{\pi} \int_{0}^{\infty}\mathcal Re( \frac{1}{iu }\phi(u) e^{-i u lnK})  du + \frac{1}{2} \\
\end{align*}
$I_1$ is a little tricky, 
\begin{align*}
        I_1 = \frac{1}{S_0} e^{-r \tau}\int_{lnK}^{\infty} e^x p(x) dx
	  = \frac{1}{S_0} e^{-r \tau}\frac{\int_{lnK}^{\infty} e^x p(x) dx}{\int_{-\infty}^{\infty} e^x p(x) dx}
	  \int_{-\infty}^{\infty} e^x p(x) dx
\end{align*}
Based on martingale property $\int_{-\infty}^{\infty} e^x p(x) dx = e^{rT}S_0$, so
\begin{align*}
	I_1 = \int_{lnK}^{\infty} \frac{e^x p(x) dx}{\int_{-\infty}^{\infty} e^x p(x) dx}
	 =  \int_{lnK}^{\infty} {p}^{'} dx
\end{align*}
The Fourier transform of function ${p}^{'}$ is
\begin{align*}
	&\frac{\int_{-\infty}^{\infty} e^{iux + x}p(x)dx}{\int_{-\infty}^{\infty} e^{i(-i)x} p(x) dx} \\
	=&\frac{\phi(u-i)}{\phi(-i)}\\
\end{align*}
So $I_1$ is
\begin{align*}
	I_1 = \frac{1}{\pi} \int_{0}^{\infty}\mathcal Re(\frac{e^{-iuln(K)}\phi(u-i)}{iu\phi(-i)})du +\frac{1}{2} \\
\end{align*}
\subsubsection{Partial Differential Equation for Heston Model} 
The Heston model states the asset price follows
\begin{align}
	dS(t) = rS(t)dt + \sqrt{V(t)} S(t) \tilde dW_1(t)
\end{align}
and the volatility itself is governed by the equation
\begin{align}
	dV(t) & = \kappa(\theta -V(t))dt + \sigma \sqrt{V(t)} \tilde dW_2(t) \\
\end{align}
Where 
\begin{align*}
	\tilde dW_1(t) \tilde dW_2(t) = \rho dt
\end{align*}
At time t, the risk-neutral price of a call expiring at time $T \geq t$ in this model is
\begin{align*}
	c(t, S(t), V(t)) = \tilde E[e^{-r(T-t)}(S(T)-K)^+|F(t)]
\end{align*}
If we move the term $c^{rt}$ to the left hand side, we see
\begin{align}
	e^{-rt}c(t, S(t), V(t)) = \tilde E[e^{-rT}(S(T)-K)^+|F(t)]
\end{align}
which satisfies the martingale property.
Then we take the differentiation of $e^{-rt}c(t, S(t), V(t))$. We get
\begin{align*}
	& d(e^{-rt}c(t, S(t), V(t))\\
	= & \frac{\partial e^{-rt}}{\partial t} c(t, S(t), V(t)) 
	+ e^{-rt}\frac{\partial c(t, S(t), V(t))}{\partial t} dt \\
	= & -re^{-rt}c(t, S(t),V(t))dt \hspace{2mm} (1)\\
	+ & e^{-rt} \frac{\partial c}{\partial t} dt \hspace{2mm} (2) \\
	+ & e^{-rt} \frac{\partial c}{\partial S} dS \hspace{2mm} (3) \\
	+ & e^{-rt} \frac{\partial^2 c}{\partial S^2} dS dS \hspace{2mm} (4)\\
	+ & e^{-rt} \frac{\partial c}{\partial V} dV \hspace{2mm} (5) \\
	+ & e^{-rt} \frac{\partial^2 c}{\partial V^2} dV dV\hspace{2mm} (6)\\
	+ & e^{-rt} \frac{\partial^2 c}{\partial V \partial S} dV dS\hspace{2mm} (7)
\end{align*}
As we are interested in only the dt terms, we find out the dt terms from (1) to (7)
the dt term in (1) is
\begin{align*}
	-rc(t, S(t), V(t))e^{-rt}dt
\end{align*}
the dt term in (2) is
\begin{align*}
	\frac{\partial c}{\partial t}e^{-rt}dt
\end{align*}
the dt term in (3) is
\begin{align*}
	\frac{\partial c}{\partial S}rSe^{-rt}dt
\end{align*}
the dt term in (4) is
\begin{align*}
	\frac{1}{2} \frac{\partial^2 c}{\partial S^2}VS^2e^{-rt}dt
\end{align*}
the dt term in (5) is
\begin{align*}
	\frac{\partial c}{\partial V}(a-bV(t))e^{-rt}dt
\end{align*}
the dt term in (6) is
\begin{align*}
	\frac{1}{2} \frac{\partial^2 c}{\partial V^2}V\sigma^2e^{-rt}dt
\end{align*}
the dt term in (7) is
\begin{align*}
	\frac{\partial^2 c}{\partial V \partial S} VS\sigma e^{-rt}dt
\end{align*}
Collect all the dt terms and let those terms equal to zero, we get
\begin{align}\label{c}
	c_t + rs c_s + (a-bv)c_v + \frac{1}{2} s^2 v c_{ss} + \rho \sigma svc_{sv}
	+\frac{1}{2} \sigma^2vc_{vv} = rc
\end{align}
The function $c(t, s, v)$ satisfies boundary condition
\begin{align*}
	c(T, s, v) = (s-K)^+ \\
	c(t, 0, v) = 0 \\
	c(t, s, 0) = (s - e^{-r(T-t)}K)^+\\
	lim_{s \to \infty} \frac{c(t, s, v)}{s-K} = 1 \\
	lim_{v \to \infty} c(t, s, v) = s\\  
\end{align*}
\subsection{Proof of Submartingale Property of European Call Option}
We know the under risk-neutral measure, the stock price $S_t$ is a martingale
\begin{align*}
	S_t = E[e^{-r(T-t)}S_T | \mathcal F(t)]
\end{align*}
Let g(T) be the European call option payoff function. Then
\begin{align*}
	g(S_t) = g(E[e^{-r(T-t)}S_T | \mathcal F(t)])
\end{align*}
By Jensen's inequality
\begin{align*}
	g(E[e^{-r(T-t)}S_T | \mathcal F(t)]) \leq E[g(e^{-r(T-t)}S_T)| \mathcal F(t)]
\end{align*}
for convex function g, we note, given $0 < \lambda < 1$
\begin{align*}
	g(\lambda s_1 + (1 - \lambda) s_2 ) \leq \lambda g(s_1) + (1 - \lambda)g(s_2)
\end{align*}
	and for call option payoff we have $g(0) = 0$, so by taking $s_2 = 0$ and $\lambda = e^{-r(T-t)}$, we have
\begin{align*}
	E[g(e^{-r(T-t)}S_T)| \mathcal F(t)] \leq E[e^{-r(T-t)}g(S_T) | \mathcal F(t)]
\end{align*}
We need to pay attention that the above equation only holds for call option. For put option, since $g(0) != 0$, so the above equation does not hold.
Combining all equations above, we have
\begin{align*}
	g(S_t) \leq E[e^{-r(T-t)}g(S_T) | \mathcal F(t)]\\
	e^{-rt}g(S_t) \leq E[e^{-rT}g(S_T)| \mathcal F(t)]\\
\end{align*}
	This shows payoff function $g(S_t)$ is a submartingale with respect to time t.
\begin{thebibliography}{9}
	\bibitem{heston}
		SL Heston,
		\textit{The Review of Financial Studies},
		"A Closed-Form Solution for Options with Stochastic Volatility with Applications 
		to Bond and Currency Options"
		Vol. 6, Issue 2, April 1993, Pages 327-343
	\bibitem{americanoption} 
		Francis Longstaff, Eduardo Schwartz, 
		"Valuing American Options by Simulation: A Simple Least-Squares Approach"
		\textit{The Review of Financial Studies}, 
		Vol. 14, Issue 1, January 2001, pp. 113-147.
	\bibitem{fulltruncation}
		Roger Lord, Remmert Koekkoek, Dick Van Dijk, 
		"A comparison of biased simulation schemes for stochastic volatility models", 
		\textit{Quantitative Finance}, 
		Vol. 10, pp. 177-194, 2010.
	\bibitem{exact_heston}
		Mark Broadie, Ozgur Kaya,
		"Exact Simulation of Stochastic Volatility and Other Affine Jump Diffusion Processes",
		\textit{Operations Research},
		Vol. 54, No. 2, 2006.
	\bibitem{geske}
		Robert Geske,
		"The Valuation of Compound Options"
		\textit{Journal of Financial Economics},
		Vol. 7 pp. 63-81, 1979.
\end{thebibliography}
\end{document}
